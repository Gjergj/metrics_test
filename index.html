<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Prometheus Dashboard</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    </head>
    <body>
        <div style="padding: 20px">
            <h2>Prometheus Metrics Dashboard</h2>

            <!-- Configuration -->
            <div style="margin-bottom: 20px">
                <label>Prometheus URL: </label>
                <input
                    type="text"
                    id="prometheusUrl"
                    value="http://localhost:9090"
                    style="width: 200px"
                />
                <br /><br />
                <label>Query: </label>
                <input
                    type="text"
                    id="query"
                    value='sum(otel_system_filesystem_usage_bytes{state="used"})'
                    style="width: 400px"
                />
                <br /><br />
                <label>Start Time: </label>
                <input
                    type="text"
                    id="startTime"
                    value="1754679174.3240001"
                    style="width: 150px"
                />
                <br /><br />
                <label>End Time: </label>
                <input
                    type="text"
                    id="endTime"
                    value="1754679178.226"
                    style="width: 150px"
                />
                <br /><br />
                <label>Step: </label>
                <input type="text" id="step" value="1" style="width: 100px" />
                <br /><br />
                <button onclick="fetchMetrics()" style="padding: 10px 20px">
                    Fetch Metrics
                </button>
            </div>

            <!-- Chart Container -->
            <div
                id="chart"
                style="width: 100%; height: 600px; background-color: #2d2d2d"
            ></div>
        </div>

        <script>
            async function fetchPrometheusData(
                prometheusUrl,
                query,
                start,
                end,
                step,
            ) {
                const url = `${prometheusUrl}/api/v1/query_range?query=${encodeURIComponent(query)}&start=${start}&end=${end}&step=${step}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error("Error fetching data:", error);
                    throw error;
                }
            }

            function processPrometheusData(data) {
                if (
                    !data.data ||
                    !data.data.result ||
                    data.data.result.length === 0
                ) {
                    return { timestamps: [], values: [] };
                }

                const result = data.data.result[0]; // Take first result
                const timestamps = [];
                const values = [];

                result.values.forEach((point) => {
                    timestamps.push(new Date(point[0] * 1000)); // Convert Unix timestamp to Date
                    values.push(parseFloat(point[1]));
                });

                return { timestamps, values };
            }

            function displayTimeSeriesChart(query, timestamps, values) {
                // Convert bytes to GB for display
                const formatValue = (bytes) => {
                    const gb = bytes / (1024 * 1024 * 1024);
                    return gb.toFixed(2);
                };

                const formattedValues = values.map((v) => formatValue(v));

                const trace = {
                    x: timestamps,
                    y: formattedValues,
                    type: "scatter",
                    mode: "lines",
                    name: query,
                    line: {
                        color: "#4CAF50",
                        width: 2,
                        shape: "spline",
                        smoothing: 1.3,
                    },
                    fill: "tozeroy",
                    fillcolor: "rgba(76, 175, 80, 0.2)",
                };

                const layout = {
                    title: {
                        text: "Filesystem Usage Over Time",
                        font: {
                            color: "white",
                            size: 24,
                        },
                    },
                    paper_bgcolor: "#2d2d2d",
                    plot_bgcolor: "#2d2d2d",
                    font: {
                        color: "white",
                    },
                    xaxis: {
                        gridcolor: "#555",
                        tickformat: "%H:%M:%S",
                        title: {
                            text: "Time",
                            font: { color: "white" },
                        },
                    },
                    yaxis: {
                        gridcolor: "#555",
                        title: {
                            text: "Value (GB)",
                            font: { color: "white" },
                        },
                    },
                    margin: {
                        t: 60,
                        r: 30,
                        b: 60,
                        l: 60,
                    },
                    showlegend: false,
                };

                const config = {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                };

                Plotly.newPlot("chart", [trace], layout, config);

                // Also display summary info
                const infoDiv = document.createElement("div");
                infoDiv.style.cssText =
                    "margin-top: 20px; padding: 20px; background: #444; border-radius: 8px; color: white;";

                const avgValue =
                    values.reduce((a, b) => a + b, 0) / values.length;
                const minValue = Math.min(...values);
                const maxValue = Math.max(...values);

                infoDiv.innerHTML = `
                <h3>Time Series Summary:</h3>
                <p><strong>Query:</strong> ${query}</p>
                <p><strong>Data Points:</strong> ${values.length}</p>
                <p><strong>Average:</strong> ${formatValue(avgValue)} GB (${avgValue.toLocaleString()} bytes)</p>
                <p><strong>Min:</strong> ${formatValue(minValue)} GB (${minValue.toLocaleString()} bytes)</p>
                <p><strong>Max:</strong> ${formatValue(maxValue)} GB (${maxValue.toLocaleString()} bytes)</p>
                <p><em>Last updated: ${new Date().toLocaleTimeString()}</em></p>
            `;

                // Remove existing info div if it exists
                const existingInfo = document.getElementById("metric-info");
                if (existingInfo) {
                    existingInfo.remove();
                }

                infoDiv.id = "metric-info";
                document.body.appendChild(infoDiv);
            }

            async function fetchMetrics() {
                const prometheusUrl =
                    document.getElementById("prometheusUrl").value;
                const query = document.getElementById("query").value;
                const startTime = document.getElementById("startTime").value;
                const endTime = document.getElementById("endTime").value;
                const step = document.getElementById("step").value;

                try {
                    // Show loading
                    document.getElementById("chart").innerHTML =
                        '<div style="text-align: center; padding: 200px; color: white;">Loading...</div>';

                    // Fetch time series data
                    const data = await fetchPrometheusData(
                        prometheusUrl,
                        query,
                        startTime,
                        endTime,
                        step,
                    );
                    const result = processPrometheusData(data);

                    if (result.values.length === 0) {
                        throw new Error(
                            "No data returned from Prometheus query",
                        );
                    }

                    // Display time series chart
                    displayTimeSeriesChart(
                        query,
                        result.timestamps,
                        result.values,
                    );
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById("chart").innerHTML =
                        `<div style="text-align: center; padding: 200px; color: red;">Error: ${error.message}</div>`;
                }
            }

            // Initialize with sample data if Prometheus is not available
            function initializeSampleData() {
                // Sample time series data
                const timestamps = [
                    new Date(1754679174324),
                    new Date(1754679175324),
                    new Date(1754679176324),
                    new Date(1754679177324),
                ];

                const values = [
                    161110835200, 161110835200, 161110835200, 161110835200,
                ];

                displayTimeSeriesChart(
                    'sum(otel_system_filesystem_usage_bytes{state="used"})',
                    timestamps,
                    values,
                );
            }

            // Initialize with sample data on page load
            initializeSampleData();
        </script>
    </body>
</html>
